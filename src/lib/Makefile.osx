#
# Sensapex micromanipulator SDK
# (c) Sensapex 2013
#
# Makefile for OS X
#

CC = gcc

CPP_FLAGS += -W -Wall -fPIC -I.. -DUMANIPULATORCTL_LIBRARY -DWITHOUT_HI_SERIAL_PORT_SPEEDS

ifeq ($(debug),1)
	PREFIX=/local
	CPP_FLAGS += -g  -D_DEBUG 
else
	PREFIX=
	CPP_FLAGS += -O2 -DNDEBUG
endif

SRCS = crc.c extserialport.c umanipulatorctl.c
HDRS = common.h crc.h extserialport.h umanipulatorctl.h
OBJS = $(SRCS:.c=.o)

.c.o: $(HDRS)
	@$(CC) -c $(CPP_FLAGS) -o $@ $<

TARGET  = libumanipulatorctl.1.0.0.dylib
TARGET0 = libumanipulatorctl.dylib
TARGET1 = libumanipulatorctl.1.dylib
TARGET2 = libumanipulatorctl.1.0.dylib

# Mac OS X compiler and linker flags as generated by qmake
CPP_FLAGS += -arch x86_64 -Xarch_x86_64 -mmacosx-version-min=10.5
LFLAGS  = -headerpad_max_install_names -single_module -dynamiclib
LFLAGS += -compatibility_version 1.0 -current_version 1.0.0 
LFLAGS += -install_name	$(TARGET1) $(CPP_FLAGS) 
export MACOSX_DEPLOYMENT_TARGET = 10.4

# Targets
all: $(TARGET)

$(OBJS): $(SRCS) $(HDRS)

install: $(TARGET)
	install -D -v -s $(TARGET) $(DESTDIR)/usr$(PREFIX)/lib/$(TARGET)
	-ln -s $(TARGET) $(DESTDIR)/usr$(PREFIX)/lib/$(TARGET0)
	-ln -s $(TARGET) $(DESTDIR)/usr$(PREFIX)/lib/$(TARGET1)
	-ln -s $(TARGET) $(DESTDIR)/usr$(PREFIX)/lib/$(TARGET2)

$(TARGET): $(OBJS)
	-rm -f $(TARGET) $(TARGET0) $(TARGET1) $(TARGET2)
	$(CC) $(OBJS) $(LFLAGS) -o $(TARGET)
	-ln -s $(TARGET) $(TARGET0)
	-ln -s $(TARGET) $(TARGET1)
	-ln -s $(TARGET) $(TARGET2)

clean:
	rm -f $(TARGET) $(OBJS) $(TARGET0) $(TARGET1) $(TARGET2) 

